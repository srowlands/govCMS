language: php

php:
  - 5.3
  - 5.5
  # @TODO test 5.6 when we move to 5.5
  #- 5.6

cache:
  bundler: true
  apt: true

env:
  global:
  - COMPOSER_BIN_DIR=$TRAVIS_BUILD_DIR/build/bin
  - BEHAT_PARAMS='{"extensions":{"Behat\\MinkExtension":{"base_url":"http://localhost/"}}}'
  - ARTIFACTS_BUCKET=travis-ci-fails
  - secure: xMmMEQUhk8ugxJkUZnoHbQe9OXmRV4I80Uq/HU296hXB+hRmEFaH3jpE6A8Hm4k9OIaFJD2h7Ti16d93sQ7q9evUnx4JDBj5oi/8G3kCqqTHOKLiZId0nKZ+qLIUCdmXT2CASxMrYSgtIWWuJ4gkfFLfmoFvqiT/bMs/F7sDEoaZPGAjvyjMRBzysYm0utyhkEzdgW6ZwBRZvtLIpqnD9gNLJ1TaD7erisspKJA7PYHvF0L1GSqSC7EX2yNAZzZpU7BuuHxcEDGvYOK8nRZidubTQmkYhRt1nzTvCWLLwezdgpHlGRRABczWVIITYXlmQeXTji+mVd1p2b4Tk2GLJiDpOIszpxltNs65JMWH98uytfakN7wcA4dhVstiaXGJlnM6AxKWONql6IMTXaPrfz2X2Dwh+rfj9OkVjTzPAhVJRfQm4nq2XiyBtpTdYBL0Xm7gahWP1tIBMlKlSO5pyBVN2+AeBEdz69Nv21rleE/OZtve8r2GlEAT/xcXAQa13gAvquS8BfKztXQ1S/2H7Ev/CdIQ6UbxCKnjDwanEyOuJ+n0ZD83lfuVt5Rfg/7oip+I6BbGA8PFd5zWuluhKBsRDuLL+3MCnIZYGQK2QCGkpbL1U6A/p2wORoxBWuh7LrrgD5nSfu5blAFVtC7ThIAJFIZdXEkBZCNURy/f6zE=
  - secure: glt7dcWQNJqsTcFTK+/mbmjtptK836RWw/xDYCFtbNI/Z17vNpppzmch6goQrc1XUC48hGxOoHh+MERIusiGCEQzJR1qO14sZrsj0HSMt7sWlwBBQU6nTH1rm8GOgmqElA26ao5b26bm63izhznN3oQsclmvT1o0J/+HpVHXu0XMiKD0e3UG2DCkna5SvZbwQophcy64of147R6HVSaWwypTFlcJMEva3jHDPyKiKH0as3S80HGMaFCpfJBV9FjepzqjU81AEsoVmHThlDUt0hG0QGmewQYy7sZKhzQf/oz8Gf7aCE3DwFzcoRfd2QzQ1/AuFzIIUrkEOjYrqmgEVberlyeTCx7y/P40mr9yV1J/3VGtIXIxyac3SqiNeUmfFJAM6MMPfrdumcFlf0BdRSieoVuASTs7Q8Q6y1jFE/P50kKfpR8E873nJ4OrliUQ1FFusHfa8Siv2vsAucBIkzdetn9TVHzjmtWRkHg07KS+IVSt6QztPrTkx6dPqL+i9RFj+H1p+72lZXyZRYusAx8kk9FfnYICh03qsmM1qa/jyqiYv+GxOXcpXZONcKiXM/DDaLNey7nlOW9A2Hrx1zVPFIIdyJB7RMqkogJH4UBRfKnXW7QptxoSPP9F37gJ+r3Jh7hADRYralfA1nMbaqCODzxIE4oUTA0WiGboIw0=
  - secure: dpxrUCGV1xA27S5f/PMMlsEF/qFhoCGbHtkujZQmdifUXFJFoMbBc4GbmNuHHqHBbOKcA1jienrvMMGsV3sWqEC0FTM3rVs0Na0Mqq40f8J1p26lqblN5uOjVMxbYJVhuu/lybKGc6xgVvIdfm92sTWorRozP83OWQNJWBeSk4PhXMcRg9CYTIub6y8NjuL9XBgDf616dVFa2pFO2+OONeOfRVQ+ct/r7Sfh8pXuEm7Q4wmyPNl6MeDJp+p28RJKuze/uOG9ezxnEOaBIYGgpHmE+5FhqSRYgQRAQAsPsrxEjF0RG1Uv+4M0XNtGNiA8FhOQweUybQy+JNKKOwsQRFw0VhRUaHpcWt9KVoPt6ddSv524xebvbaRbPlmMSWI5RFw6cZZHbMpsQ/UsEo6vRaFjyqdIsthhz956+7ZceErQoS3QSZookQCgUPzs/5C/umWHjUNmxL5kaDYDFBumi0eBhojA9W7tMIeH4dOIzleqt4zLRT64flxaOjwzrIderOkxlqftvgVKXcHO1d8dC6ZwWkm1eYGJs2x+eY91SBtOLhsSv5yrkxooJ8EfkpsbuSeJKXvRlwLfHaes6VlJibWijX8TD8L6tl3nFK/osvSkOCcAXJnf+6JGy/0x2p2lINGo1wse61Hh56/hNlAfUlaW7VRBanBVAMtnYXsFwy8=
  - secure: b7LF69i5nAvBlSwOisRQhzbEwJRzndXnxb7E7JkiQTOeGeJOYtcMI8+2uaDfYuWFJ616Ye57zaZFPScVVZpUWV9YwYGxVPBvAzET1v2mP5Ft7rfhXhPYdD1ee0Q/Q0HDilVbA98DPHjntjuC3ev82xohbdWToJPSNgAHHPNKgRO9uFWY2qUk/6SNnz2OoyonwNudc4CO4rgJKNDmk5m9U5zo1uDQ7wX8cCU3Vcg4AVbwp0uTS25lcbrWaXdh0ssMibrPtZl/Sl8ncq5yyN6oSuc2fm7aeEH8e/ncgFrigtsoR4S8fpfXy6hfkj4CfZYT+r7To+Y/LEW6l+a7GCwowe40skJ8oDhG9RmgD3V2/BPNMYHPqz0KhuwvQ2buAWlSIwEoQSn54AkqhymYq8fm0ZbLsgBQSl/3T7V+kLhpLSau5nZS02CdMkIixTGnPq1jfOcgS2dXSE1wDUFondNJKEabf66ZMiWN7/pBDsr3UdOwWm2O/8X1hPM/N8pmDscJ1b0RODMLFICL6oqp/KmZlt2XndvdOC7/19vWqBEbpHnZNMBY/7w7zwjf8xAAbQh+VevI7PMpfaUoFomD7ja21Szu80KXAHajP7qPq7GEi75q84++CbF9w71AUvlCA/eote0qCTKChfYJAQRWeHd/l6X7j+t2cVzlhexb9KSwirQ=

addons:
  artifacts:
    bucket: travis-ci-fails
    paths:
    - $TRAVIS_BUILD_DIR/build/phing/screenshot-fail.png
    debug: true

notifications:
  email:
  - stuart.rowlands@acquia.com

before_install:
  - sudo apt-get update -qq
  - sudo apt-get install -y -qq postfix
  - composer selfupdate

install:
  - composer install --working-dir=build --prefer-source
  - export PATH=$PATH:$TRAVIS_BUILD_DIR/build/bin

before_script:
  # Create a mock mail system so Drupal install can send email somewhere.
  - sudo service postfix stop
  - smtp-sink -d "%d.%H.%M.%S" localhost:2500 1000 &
  - echo -e '#!/usr/bin/env bash\nexit 0' | sudo tee /usr/sbin/sendmail
  - echo 'sendmail_path = "/usr/sbin/sendmail -t -i "' | sudo tee "/home/travis/.phpenv/versions/`php -r 'echo PHP_VERSION;'`/etc/php.ini"

  # Install Apache
  - sudo apt-get install -y apache2 libapache2-mod-fastcgi
  - sudo cp ~/.phpenv/versions/$(phpenv version-name)/etc/php-fpm.conf.default ~/.phpenv/versions/$(phpenv version-name)/etc/php-fpm.conf
  - sudo a2enmod rewrite actions fastcgi alias
  - echo "cgi.fix_pathinfo = 1" >> ~/.phpenv/versions/$(phpenv version-name)/etc/php.ini
  - ~/.phpenv/versions/$(phpenv version-name)/sbin/php-fpm
  - sudo cp -f build/travis/travis-ci-apache /etc/apache2/sites-available/default
  - sudo sed -e "s?%TRAVIS_BUILD_DIR%?$(pwd)?g" --in-place /etc/apache2/sites-available/default
  - sudo service apache2 restart

  # Create Database
  - mysql -e 'CREATE DATABASE travis_ci_govcms_drupal;'

  # Build the codebase
  - phing -f build/phing/build.xml build:local

script:
  # Run tests
  - phing -f build/phing/build.xml run-tests

after_success:
  - phing -f build/phing/build.xml post-commit

after_failure:
  - curl -sL https://raw.githubusercontent.com/travis-ci/artifacts/master/install | bash
  - ~/bin/artifacts upload --target-paths "$TRAVIS_REPO_SLUG/$TRAVIS_BUILD_NUMBER/$TRAVIS_JOB_NUMBER" build/phing/screenshot-fail.png

